<?php

/**
 * Created by PhpStorm.
 * User: arvin
 * Date: 2016/1/16
 * Time: 22:57
 */
class Exploit_model extends CI_Model {
    /*
     * exploit数据库格式
     * id               1
     * vendor           "D-Link"
     * module           "DIR-810L"
     * version          "1.12-1.14"
     * type_exploit     "Buffer overflow"
     * ref              "https://www.exploit-db.com/exploits/33737/,https://www.exploit-db.com/exploits/33737/"
     * update           time()
     * verify           false
     * poc              import re ...
     * poc_language     python
     *
    */

    public function __construct() {
        parent::__construct();
    }

    /**
     * @param $exploit_id 查找的exploit的id
     * @return null: 未找到该id的exploit, exploit:找到的exploit对象
     */
    public function get_entry($exploit_id) {
        $exploit = $this->db->get_where("exploits", array("id" => $exploit_id))->row();

        if (!$exploit) {
            // 不存在该id的exploit
            return null;
        }
        else {
            $exploit->ref = explode(",",$exploit->ref);
//            $exploit->poc = explode("\n", $exploit->poc);
            return $exploit;
        }
    }
	/**
     * 搜索
     * @param  $q 搜索条件数组
     * @return $arr 返回符合搜索条件的数组
     */
    public function search($q,$offset,$first,$perpage){
        $s=array('title'=>1,'vendor'=>1,'module'=>1);//权重,title/vendor/module各匹配1分，按score排序List
        $d=0;
        foreach ($q as $key => $v) {
            $c=0;
            for($i=0;$i<count($q[$key]);$i++){
                $clause[$key][$c++] = " (".$key." LIKE '%".$v[$i]."%') ";
                $score[$d++] = " IF(LOCATE('".$v[$i]."', ".$key."), ".$s[$key].", 0) ";
            }
            $clause[$key]= "(".implode(" OR ",$clause[$key]).")";
        } 
        $sql = "SELECT id, title,vendor,module,(".implode("+",$score).") AS score FROM exploits WHERE (";
        $sql=$sql.implode(" AND ",$clause);
        $sql=$sql.")ORDER BY score DESC ";
        if(!$first){
            $sql=$sql."limit  ".$offset.",".$perpage;
        }
        $query= $this->db->query($sql);
        $arr =array();
        if($query->num_rows() > 0){
            foreach ($query->result_array() as $row) {
                array_push($arr, $row);
            }
        }
        return $arr;
    }
    /*
    用户输入提示
    public function hint($keywords) {
        $q=explode(" ",$keywords);
        $a='SELECT* FROM exploits where vendor like "%'.$q[0].'%"';
        $a=$a.'and vendor like "%'.$q[1].'%"';
        $query= $this->db->query($a);
        $arr =array();
        if($query->num_rows() > 0){
            foreach ($query->result_array() as $row) {
                array_push($arr, $row);
            }
        }
        return $arr;
    }
    */
}