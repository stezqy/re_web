<?php

/**
 * Created by PhpStorm.
 * User: arvin
 * Date: 2016/1/16
 * Time: 22:44
 */
class Exploit extends CI_Controller{
    public function __construct() {
        parent::__construct();
        $this->load->library('authentication');
    }

    public function index() {
        $exploit_id = trim($this->input->get("id"));
        if (is_null($exploit_id)) {
            $exploit_id = 1;
        }

        $this->load->model("exploit_model");
        $exploit_entry = $this->exploit_model->get_entry($exploit_id);
        if (is_null($exploit_entry)) {
            show_404();
        }
        else {
            $this->load->view("header/header_login", array("username" => $this->user_model->get_username()));
            $this->load->view("exploit", array("exploit" => $exploit_entry));
            $this->load->view("footer/footer");
        }
    }

    public function download_exploit() {
        $exploit_id = trim($this->input->get("id"));

        // 如果传入参数id为空
        if (is_null($exploit_id)) {
            show_404();
        }

        $this->load->model("exploit_model");
        $exploit_entry = $this->exploit_model->get_entry($exploit_id);
        // 找不到该exploit
        if (is_null($exploit_entry)) {
            show_404();
        }
        else {
            $this->load->helper('download');
            $file_name = "exploit-" . strval($exploit_entry->id) . "." . $this->file_postfix($exploit_entry->poc_language);
            $data = $exploit_entry->poc;
            force_download($file_name, $data);
        }
    }

    private function file_postfix($exploit_language) {
        switch ($exploit_language) {
            case "python":
                return "py";
            case "ruby":
                return "rb";
            default:
                return "txt";
        }
    }
}